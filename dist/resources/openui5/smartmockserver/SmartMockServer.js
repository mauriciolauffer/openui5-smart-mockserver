/*
 * openui5-smart-mockserver
 * (c) Copyright 2018-2020 Mauricio Lauffer
 * Licensed under the MIT license. See LICENSE file in the project root for full license information.
 */
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/util/MockServer","openui5/smartmockserver/thirdparty/faker.min"],function(t,e,r){"use strict";const n=r;n.prototype._generateDataFromEntityOriginal=n.prototype._generateDataFromEntity;n.prototype.SAP_SEMANTICS_TO_FAKER_METHOD_MAPPING=[{sapSemantics:"city",fakerMethod:"address.city"},{sapSemantics:"country",fakerMethod:"address.country"},{sapSemantics:"geo-lat",fakerMethod:"address.latitude"},{sapSemantics:"geo-lon",fakerMethod:"address.longitude"},{sapSemantics:"region",fakerMethod:"address.state"},{sapSemantics:"street",fakerMethod:"address.streetAddress"},{sapSemantics:"zip",fakerMethod:"address.zipCode"},{sapSemantics:"org",fakerMethod:"company.companyName"},{sapSemantics:"currency-code",fakerMethod:"finance.currencyCode"},{sapSemantics:"photo",fakerMethod:"image.avatar"},{sapSemantics:"bcc",fakerMethod:"internet.email"},{sapSemantics:"cc",fakerMethod:"internet.email"},{sapSemantics:"email",fakerMethod:"internet.email"},{sapSemantics:"from",fakerMethod:"internet.email"},{sapSemantics:"sender",fakerMethod:"internet.email"},{sapSemantics:"to",fakerMethod:"internet.email"},{sapSemantics:"url",fakerMethod:"internet.url"},{sapSemantics:"body",fakerMethod:"lorem.paragraphs"},{sapSemantics:"subject",fakerMethod:"lorem.sentence"},{sapSemantics:"name",fakerMethod:"name.findName"},{sapSemantics:"givenname",fakerMethod:"name.firstName"},{sapSemantics:"middlename",fakerMethod:"name.firstName"},{sapSemantics:"title",fakerMethod:"name.jobTitle"},{sapSemantics:"familyname",fakerMethod:"name.lastName"},{sapSemantics:"honorific",fakerMethod:"name.prefix"},{sapSemantics:"suffix",fakerMethod:"name.suffix"},{sapSemantics:"tel",fakerMethod:"phone.phoneNumber"}];n.prototype._generateDataFromEntity=function(t,e,r){const a=n.prototype._generateDataFromEntityOriginal.apply(this,arguments);return this._generateDataWithSmartRules(t.name,a)};n.prototype._generateDataWithSmartRules=function(r,n){try{if(!this._smartRules){this._smartRules=[]}let t=e.extend(true,{},n);t=this._generateDataFromEntityWithSapSemanticsAnnotations(r,t);t=this._generateDataFromEntityWithSmartMockServerAnnotations(r,t);t=this._generateDataFromEntityWithSmartRules(r,t);return t}catch(e){t.error(e);return n}};n.prototype._generateDataFromEntityWithSmartRules=function(t,r){if(this._hasSmartRulesEntity(t)){const n=e.extend(true,{},r);Object.keys(n).forEach(function(e){if(this._hasSmartRulesEntityProperty(t,e)){n[e]=this._generatePropertyValueWithSmartRules(t,e)}}.bind(this));return n}else{return r}};n.prototype._getEntityPropertiesWithSapSemanticsAnnotations=function(t){const r='EntityType[Name="'+t+'"]';const n="Property[sap\\:semantics]";return e(this._oMetadata).find(r).find(n)};n.prototype._generateDataFromEntityWithSapSemanticsAnnotations=function(t,r){const n=this._getEntityPropertiesWithSapSemanticsAnnotations(t);if(n&&n.length&&n.length>0){const t=e.extend(true,{},r);n.each(function(r,n){const a=e(n);const o=this._getFakerMethodFromSapSemantics(a.attr("sap:semantics"));if(o){t[a.attr("Name")]=this._callFakerMethod(o)}}.bind(this));return t}else{return r}};n.prototype._getFakerMethodFromSapSemantics=function(t){const e=this.SAP_SEMANTICS_TO_FAKER_METHOD_MAPPING.find(function(e){return e.sapSemantics===t});if(e){return e.fakerMethod}else{return e}};n.prototype._getEntityPropertiesWithSmartMockServerAnnotations=function(t){const r='EntityType[Name="'+t+'"]';const n="Property[smartmockserver\\:rule]";return e(this._oMetadata).find(r).find(n)};n.prototype._generateDataFromEntityWithSmartMockServerAnnotations=function(t,r){const n=this._getEntityPropertiesWithSmartMockServerAnnotations(t);if(n&&n.length&&n.length>0){const t=e.extend(true,{},r);n.each(function(r,n){const a=e(n);const o=a.attr("smartmockserver:rule");if(o){t[a.attr("Name")]=this._callFakerMethod(o)}}.bind(this));return t}else{return r}};n.prototype._generatePropertyValueWithSmartRules=function(t,e){const r=this._getSmartRulesEntityProperty(t,e);return this._callFakerMethod(r.fakerMethod)};n.prototype._callFakerMethod=function(t){return faker.fake("{{"+t+"}}")};n.prototype._getSmartRulesEntity=function(t){return this._smartRules.find(function(e){return e.entityName===t})};n.prototype._getSmartRulesEntityProperty=function(t,e){const r=this._getSmartRulesEntity(t);if(!r){return r}return r.properties.find(function(t){return t.name===e})};n.prototype._hasSmartRulesEntity=function(t){return!!this._getSmartRulesEntity(t)};n.prototype._hasSmartRulesEntityProperty=function(t,e){return!!this._getSmartRulesEntityProperty(t,e)};n.prototype.setSmartRules=function(t){this._smartRules=t||[]};const a={REQUEST:"REQUEST",MOCK_RESPONSE:"MOCK_RESPONSE",REGISTER_MOCK_SERVER:"REGISTER_MOCK_SERVER",START_MOCK_SERVER:"START_MOCK_SERVER",STOP_MOCK_SERVER:"STOP_MOCK_SERVER",UNKNOWN_MESSAGE:"UNKNOWN_MESSAGE"};n.getAll=function(){return r._aServers};n.registerServiceWorker=function(e){n.getAll().forEach(function(t){t.start();t.stop()});navigator.serviceWorker.addEventListener("message",c);return navigator.serviceWorker.register(e).then(function(){o();const t=u();return f(a.REGISTER_MOCK_SERVER,t)}).catch(function(e){t.error("ServiceWorker not registered!");t.error(e)})};n.prototype.isServiceWorkerStarted=function(){return this._isServiceWorkerStarted};n.prototype.startServiceWorker=function(){this._isServiceWorkerStarted=true;const t={rootUri:this.getRootUri(),active:this.isServiceWorkerStarted()};return f(a.START_MOCK_SERVER,t)};n.prototype.stopServiceWorker=function(){this._isServiceWorkerStarted=false;const t={rootUri:this.getRootUri(),active:this.isServiceWorkerStarted()};return f(a.STOP_MOCK_SERVER,t)};function o(){e.ajaxPrefilter(function(e,r,n){if(e.async){return}const a=i(e.url);if(!a){return}const o={url:e.url,method:e.type,mockServer:{path:"JUST_TO_AVOID_TO_BE_FOUND"}};const c=s(o,a);if(!c){return}try{e.beforeSend=function(t,e){a.start();e.url=e.url.replace(window.location.origin,"")};n.complete(function(){a.stop()})}catch(e){t.error(e)}})}function i(t){return n.getAll().filter(function(e){const r=new RegExp(e.getRootUri());return r.test(t)})[0]}function s(t,e){if(!e){return}return e.getRequests().filter(function(e){if(e.method.toLowerCase()!==t.method.toLowerCase()){return false}const r=e.path.toString()==="/$/";if(r&&t.mockServer.path==="$"){return r}else if(!r){return e.path instanceof RegExp?e.path.test(t.url):e.path===t.url}})[0]}function c(e){if(e.data.type!==a.REQUEST){return}p(e.data.payload).then(function(t){e.ports[0].postMessage({type:a.MOCK_RESPONSE,payload:JSON.stringify(t)})}).catch(function(r){t.error(r);e.ports[0].postMessage({type:a.MOCK_RESPONSE,error:true,payload:JSON.stringify(r)})})}function p(t){return new Promise(function(e,r){const n=JSON.parse(t);const a=i(n.url);const o=s(n,a);if(!o){r(new Error("No request was found in MockServer"))}const c=Object.assign({},n);const p=typeof o.path.exec==="function"?o.path.exec(c.url).slice(1):[];c.respond=function(){e(arguments)};c.respondFile=c.respondJSON=c.respondXML=c.respond;o.response(c,p[0],p[1])})}function u(){return n.getAll().map(function(t){const e=t.getRequests().map(function(t){const e={method:t.method,path:t.path,isRegExp:t.path instanceof RegExp};if(e.isRegExp){const t=e.path.toString();const r=t.substring(t.indexOf("/")+1,t.lastIndexOf("/"));const n=t==="/$/";e.path=n?"$":r}return e});return{active:false,rootUri:t.getRootUri(),requests:e}})}function f(t,e){return navigator.serviceWorker.ready.then(function(r){r.active.postMessage({type:t,payload:JSON.stringify(e)})})}return n});